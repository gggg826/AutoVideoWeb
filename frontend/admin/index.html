<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨ç›˜ - AdAlliance ç®¡ç†åå°</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¯ AdAlliance</h2>
                <p>ç®¡ç†åå°</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/index.html" class="nav-item active">ğŸ“Š ä»ªè¡¨ç›˜</a>
                <a href="/admin/logs.html" class="nav-item">ğŸ“‹ è®¿é—®æ—¥å¿—</a>
                <a href="/public/index.html" class="nav-item">ğŸ§ª æµ‹è¯•é¡µé¢</a>
                <a href="/docs" class="nav-item">ğŸ“š API æ–‡æ¡£</a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <h1>ğŸ“Š æ•°æ®ä»ªè¡¨ç›˜</h1>
                <div class="top-bar-actions">
                    <select id="periodSelect" class="btn btn-secondary">
                        <option value="7">æœ€è¿‘ 7 å¤©</option>
                        <option value="14">æœ€è¿‘ 14 å¤©</option>
                        <option value="30">æœ€è¿‘ 30 å¤©</option>
                    </select>
                    <button onclick="loadDashboard()" class="btn btn-primary">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid" id="statsCards">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="card">
                <div class="card-header">
                    <h3>ğŸ“ˆ è®¿é—®è¶‹åŠ¿</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- è®¾å¤‡åˆ†å¸ƒ -->
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ’» è®¾å¤‡åˆ†å¸ƒ</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- æµè§ˆå™¨åˆ†å¸ƒ -->
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸŒ æµè§ˆå™¨åˆ†å¸ƒ</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="browserChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœ°ç†ä½ç½®åˆ†å¸ƒ -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>ğŸŒ è®¿é—®åœ°ç†ä½ç½®åˆ†å¸ƒ</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="/static/js/admin/api.js"></script>
    <script>
        // Check authentication before page loads
        (function() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = '/admin/login.html';
                throw new Error('No token');
            }
        })();

        let trendChart, deviceChart, browserChart, locationChart;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();

            // ç›‘å¬å‘¨æœŸé€‰æ‹©å˜åŒ–
            document.getElementById('periodSelect').addEventListener('change', loadDashboard);
        });

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboard() {
            const days = parseInt(document.getElementById('periodSelect').value);

            try {
                // åŠ è½½ç»Ÿè®¡æ‘˜è¦
                await loadStats(days);

                // åŠ è½½è¶‹åŠ¿å›¾è¡¨
                await loadTrendChart(days);

                // åŠ è½½è®¾å¤‡ç»Ÿè®¡
                await loadDeviceStats(days);

                // åŠ è½½åœ°ç†ä½ç½®ç»Ÿè®¡
                await loadLocationChart(days);
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åŠ è½½ç»Ÿè®¡å¡ç‰‡
        async function loadStats(days) {
            const container = document.getElementById('statsCards');
            Utils.showLoading(container);

            try {
                const response = await API.stats.getSummary(days);
                const stats = response.data;

                const todayChange = stats.yesterday_visits > 0
                    ? ((stats.today_visits - stats.yesterday_visits) / stats.yesterday_visits * 100).toFixed(1)
                    : 0;

                container.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">æ€»è®¿é—®é‡</div>
                            <div class="stat-card-icon">ğŸ“Š</div>
                        </div>
                        <div class="stat-card-value">${stats.total_visits.toLocaleString()}</div>
                        <div class="stat-card-trend">å…¨éƒ¨æ•°æ®</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">ä»Šæ—¥è®¿é—®</div>
                            <div class="stat-card-icon">ğŸŒ</div>
                        </div>
                        <div class="stat-card-value">${stats.today_visits.toLocaleString()}</div>
                        <div class="stat-card-trend ${todayChange >= 0 ? 'trend-up' : 'trend-down'}">
                            ${todayChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${Math.abs(todayChange)}% å¯¹æ¯”æ˜¨æ—¥
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">å¹³å‡è¯„åˆ†</div>
                            <div class="stat-card-icon">â­</div>
                        </div>
                        <div class="stat-card-value">${stats.avg_authenticity_score}</div>
                        <div class="stat-card-trend">çœŸå®æ€§è¯„åˆ†ï¼ˆ0-100ï¼‰</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">æœºå™¨äººæ¯”ä¾‹</div>
                            <div class="stat-card-icon">ğŸ¤–</div>
                        </div>
                        <div class="stat-card-value">${stats.bot_rate}%</div>
                        <div class="stat-card-trend">${stats.bot_visits} ä¸ªæœºå™¨äººè®¿é—®</div>
                    </div>
                `;
            } catch (error) {
                Utils.showError(container, 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
                throw error;
            }
        }

        // åŠ è½½è¶‹åŠ¿å›¾è¡¨
        async function loadTrendChart(days) {
            try {
                const response = await API.stats.getTrend(days);
                const data = response.data;

                const labels = data.map(d => Format.date(d.date));
                const visits = data.map(d => d.visits);
                const scores = data.map(d => d.avg_score);

                if (trendChart) {
                    trendChart.destroy();
                }

                const ctx = document.getElementById('trendChart').getContext('2d');
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'è®¿é—®é‡',
                                data: visits,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'å¹³å‡è¯„åˆ†',
                                data: scores,
                                borderColor: '#48bb78',
                                backgroundColor: 'rgba(72, 187, 120, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'è®¿é—®é‡'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'è¯„åˆ†'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                max: 100
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿å›¾è¡¨å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½è®¾å¤‡ç»Ÿè®¡
        async function loadDeviceStats(days) {
            try {
                const response = await API.stats.getDevices(days);
                const stats = response.data;

                // è®¾å¤‡åˆ†å¸ƒé¥¼å›¾
                if (deviceChart) {
                    deviceChart.destroy();
                }

                const deviceCtx = document.getElementById('deviceChart').getContext('2d');
                deviceChart = new Chart(deviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: stats.devices.map(d => Format.deviceType(d.name)),
                        datasets: [{
                            data: stats.devices.map(d => d.count),
                            backgroundColor: [
                                '#667eea',
                                '#48bb78',
                                '#ed8936',
                                '#f56565'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });

                // æµè§ˆå™¨åˆ†å¸ƒé¥¼å›¾
                if (browserChart) {
                    browserChart.destroy();
                }

                const browserCtx = document.getElementById('browserChart').getContext('2d');
                browserChart = new Chart(browserCtx, {
                    type: 'pie',
                    data: {
                        labels: stats.browsers.map(d => d.name),
                        datasets: [{
                            data: stats.browsers.map(d => d.count),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#48bb78', '#ed8936',
                                '#f56565', '#9f7aea', '#38b2ac', '#ecc94b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡ç»Ÿè®¡å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½åœ°ç†ä½ç½®ç»Ÿè®¡
        async function loadLocationChart(days) {
            try {
                const response = await API.stats.getLocations(days);
                const stats = response.data;

                // åœ°ç†ä½ç½®æ¡å½¢å›¾
                if (locationChart) {
                    locationChart.destroy();
                }

                const locationCtx = document.getElementById('locationChart').getContext('2d');
                locationChart = new Chart(locationCtx, {
                    type: 'bar',
                    data: {
                        labels: stats.countries.map(d => d.code),
                        datasets: [{
                            label: 'è®¿é—®é‡',
                            data: stats.countries.map(d => d.count),
                            backgroundColor: '#667eea',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const countryCode = context.label;
                                        const cities = stats.cities
                                            .filter(c => c.country === countryCode)
                                            .map(c => `${c.city}: ${c.count}`)
                                            .slice(0, 5);
                                        return cities.length > 0 ? cities : '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'è®¿é—®é‡'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'å›½å®¶/åœ°åŒº'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½åœ°ç†ä½ç½®ç»Ÿè®¡å¤±è´¥:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
