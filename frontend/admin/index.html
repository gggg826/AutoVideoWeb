<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨ç›˜ - AdAlliance ç®¡ç†åå°</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¯ AdAlliance</h2>
                <p>ç®¡ç†åå°</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/index.html" class="nav-item active">ğŸ“Š ä»ªè¡¨ç›˜</a>
                <a href="/admin/logs.html" class="nav-item">ğŸ“‹ è®¿é—®æ—¥å¿—</a>
                <a href="/public/index.html" class="nav-item">ğŸ§ª æµ‹è¯•é¡µé¢</a>
                <a href="/docs" class="nav-item">ğŸ“š API æ–‡æ¡£</a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <h1>ğŸ“Š æ•°æ®ä»ªè¡¨ç›˜</h1>
                <div class="top-bar-actions">
                    <select id="periodSelect" class="btn btn-secondary">
                        <option value="7">æœ€è¿‘ 7 å¤©</option>
                        <option value="14">æœ€è¿‘ 14 å¤©</option>
                        <option value="30">æœ€è¿‘ 30 å¤©</option>
                    </select>
                    <button onclick="loadDashboard()" class="btn btn-primary">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid" id="statsCards">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="card">
                <div class="card-header">
                    <h3>ğŸ“ˆ è®¿é—®è¶‹åŠ¿</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- è®¾å¤‡åˆ†å¸ƒ -->
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ’» è®¾å¤‡åˆ†å¸ƒ</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- æ¥æºæ¸ é“åˆ†å¸ƒ -->
                <div class="card">
                    <div class="card-header">
                        <h3>ğŸ”— æ¥æºæ¸ é“åˆ†å¸ƒ</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="referrerChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœ°ç†ä½ç½®åˆ†å¸ƒ -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>ğŸŒ è®¿é—®åœ°ç†ä½ç½®åˆ†å¸ƒ</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†å‘˜æœ¬åœ°æ—¶é—´è®¿é—®åˆ†å¸ƒ -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3>ğŸ• ç®¡ç†å‘˜æœ¬åœ°æ—¶é—´è®¿é—®åˆ†å¸ƒï¼ˆæœ€è¿‘24å°æ—¶ï¼‰</h3>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="hourlyAdminChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- è®¿é—®è€…æœ¬åœ°æ—¶é—´è®¿é—®åˆ†å¸ƒ -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>ğŸŒ è®¿é—®è€…æœ¬åœ°æ—¶é—´è®¿é—®åˆ†å¸ƒï¼ˆæœ€è¿‘24å°æ—¶ï¼‰</h3>
                        <select id="visitorCountrySelect" class="btn btn-secondary" style="min-width: 150px;">
                            <option value="">æ‰€æœ‰å›½å®¶</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="hourlyVisitorChart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="/static/js/admin/api.js"></script>
    <script>
        // Check authentication before page loads
        (function() {
            const token = localStorage.getItem('admin_token');
            if (!token) {
                window.location.href = '/admin/login.html';
                throw new Error('No token');
            }
        })();

        let trendChart, deviceChart, referrerChart, locationChart, hourlyAdminChart, hourlyVisitorChart;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();

            // ç›‘å¬å‘¨æœŸé€‰æ‹©å˜åŒ–
            document.getElementById('periodSelect').addEventListener('change', loadDashboard);

            // ç›‘å¬å›½å®¶é€‰æ‹©å˜åŒ–
            document.getElementById('visitorCountrySelect').addEventListener('change', async () => {
                const country = document.getElementById('visitorCountrySelect').value;
                await loadHourlyVisitorChart(country);
            });
        });

        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboard() {
            const days = parseInt(document.getElementById('periodSelect').value);

            // ä½¿ç”¨Promise.allSettledè®©æ¯ä¸ªå›¾è¡¨ç‹¬ç«‹åŠ è½½ï¼Œå¤±è´¥ä¸å½±å“å…¶ä»–
            const results = await Promise.allSettled([
                loadStats(days).catch(err => {
                    console.error('åŠ è½½ç»Ÿè®¡æ‘˜è¦å¤±è´¥:', err);
                    throw err;
                }),
                loadTrendChart(days).catch(err => {
                    console.error('åŠ è½½è¶‹åŠ¿å›¾è¡¨å¤±è´¥:', err);
                }),
                loadDeviceStats(days).catch(err => {
                    console.error('åŠ è½½è®¾å¤‡ç»Ÿè®¡å¤±è´¥:', err);
                }),
                loadReferrerChart(days).catch(err => {
                    console.error('åŠ è½½æ¥æºæ¸ é“ç»Ÿè®¡å¤±è´¥:', err);
                }),
                loadLocationChart(days).catch(err => {
                    console.error('åŠ è½½åœ°ç†ä½ç½®ç»Ÿè®¡å¤±è´¥:', err);
                }),
                loadHourlyAdminChart().catch(err => {
                    console.error('åŠ è½½ç®¡ç†å‘˜æ—¶é—´åˆ†å¸ƒå¤±è´¥:', err);
                }),
                loadHourlyVisitorChart().catch(err => {
                    console.error('åŠ è½½è®¿é—®è€…æ—¶é—´åˆ†å¸ƒå¤±è´¥:', err);
                }),
                loadCountryList().catch(err => {
                    console.error('åŠ è½½å›½å®¶åˆ—è¡¨å¤±è´¥:', err);
                })
            ]);

            // æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„è¯·æ±‚
            const failures = results.filter(r => r.status === 'rejected');
            if (failures.length > 0) {
                console.error('éƒ¨åˆ†å›¾è¡¨åŠ è½½å¤±è´¥:', failures);
                // åªåœ¨æ‰€æœ‰è¯·æ±‚éƒ½å¤±è´¥æ—¶æ‰æ˜¾ç¤ºé”™è¯¯æç¤º
                const successes = results.filter(r => r.status === 'fulfilled');
                if (successes.length === 0) {
                    alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
        }

        // åŠ è½½ç»Ÿè®¡å¡ç‰‡
        async function loadStats(days) {
            const container = document.getElementById('statsCards');
            Utils.showLoading(container);

            try {
                const response = await API.stats.getSummary(days);
                const stats = response.data;

                const todayChange = stats.yesterday_visits > 0
                    ? ((stats.today_visits - stats.yesterday_visits) / stats.yesterday_visits * 100).toFixed(1)
                    : 0;

                container.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">æ€»è®¿é—®é‡</div>
                            <div class="stat-card-icon">ğŸ“Š</div>
                        </div>
                        <div class="stat-card-value">${stats.total_visits.toLocaleString()}</div>
                        <div class="stat-card-trend">å…¨éƒ¨æ•°æ®</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">ä»Šæ—¥è®¿é—®</div>
                            <div class="stat-card-icon">ğŸŒ</div>
                        </div>
                        <div class="stat-card-value">${stats.today_visits.toLocaleString()}</div>
                        <div class="stat-card-trend ${todayChange >= 0 ? 'trend-up' : 'trend-down'}">
                            ${todayChange >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${Math.abs(todayChange)}% å¯¹æ¯”æ˜¨æ—¥
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">å¹³å‡è¯„åˆ†</div>
                            <div class="stat-card-icon">â­</div>
                        </div>
                        <div class="stat-card-value">${stats.avg_authenticity_score}</div>
                        <div class="stat-card-trend">çœŸå®æ€§è¯„åˆ†ï¼ˆ0-100ï¼‰</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">æœºå™¨äººæ¯”ä¾‹</div>
                            <div class="stat-card-icon">ğŸ¤–</div>
                        </div>
                        <div class="stat-card-value">${stats.bot_rate}%</div>
                        <div class="stat-card-trend">${stats.bot_visits} ä¸ªæœºå™¨äººè®¿é—®</div>
                    </div>
                `;
            } catch (error) {
                Utils.showError(container, 'åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥');
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®è¯¦ç»†é”™è¯¯:', error);
            }
        }

        // åŠ è½½è¶‹åŠ¿å›¾è¡¨
        async function loadTrendChart(days) {
            try {
                const response = await API.stats.getTrend(days);
                const data = response.data;

                const labels = data.map(d => Format.date(d.date));
                const visits = data.map(d => d.visits);
                const scores = data.map(d => d.avg_score);

                if (trendChart) {
                    trendChart.destroy();
                }

                const ctx = document.getElementById('trendChart').getContext('2d');
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'è®¿é—®é‡',
                                data: visits,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'å¹³å‡è¯„åˆ†',
                                data: scores,
                                borderColor: '#48bb78',
                                backgroundColor: 'rgba(72, 187, 120, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'è®¿é—®é‡'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'è¯„åˆ†'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                                max: 100
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½è¶‹åŠ¿å›¾è¡¨è¯¦ç»†é”™è¯¯:', error);
            }
        }

        // åŠ è½½è®¾å¤‡ç»Ÿè®¡
        async function loadDeviceStats(days) {
            try {
                const response = await API.stats.getDevices(days);
                const stats = response.data;

                // è®¾å¤‡åˆ†å¸ƒé¥¼å›¾
                if (deviceChart) {
                    deviceChart.destroy();
                }

                const deviceCtx = document.getElementById('deviceChart').getContext('2d');
                deviceChart = new Chart(deviceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: stats.devices.map(d => Format.deviceType(d.name)),
                        datasets: [{
                            data: stats.devices.map(d => d.count),
                            backgroundColor: [
                                '#667eea',
                                '#48bb78',
                                '#ed8936',
                                '#f56565'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½è®¾å¤‡ç»Ÿè®¡è¯¦ç»†é”™è¯¯:', error);
            }
        }

        // åŠ è½½æ¥æºæ¸ é“ç»Ÿè®¡
        async function loadReferrerChart(days) {
            try {
                const response = await API.stats.getReferrers(days);
                const stats = response.data;

                // æ¥æºæ¸ é“é¥¼å›¾
                if (referrerChart) {
                    referrerChart.destroy();
                }

                // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºå ä½ä¿¡æ¯
                if (!stats.referrers || stats.referrers.length === 0) {
                    const referrerCtx = document.getElementById('referrerChart').getContext('2d');
                    referrerChart = new Chart(referrerCtx, {
                        type: 'pie',
                        data: {
                            labels: ['æš‚æ— æ•°æ®'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e2e8f0']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                    return;
                }

                const referrerCtx = document.getElementById('referrerChart').getContext('2d');
                referrerChart = new Chart(referrerCtx, {
                    type: 'pie',
                    data: {
                        labels: stats.referrers.map(d => d.name),
                        datasets: [{
                            data: stats.referrers.map(d => d.count),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#48bb78', '#ed8936',
                                '#f56565', '#9f7aea', '#38b2ac', '#ecc94b',
                                '#fc8181', '#63b3ed', '#f6ad55', '#68d391'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 12,
                                    padding: 10
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½æ¥æºæ¸ é“ç»Ÿè®¡è¯¦ç»†é”™è¯¯:', error);
            }
        }

        // åŠ è½½åœ°ç†ä½ç½®ç»Ÿè®¡
        async function loadLocationChart(days) {
            try {
                const response = await API.stats.getLocations(days);
                const stats = response.data;

                // åœ°ç†ä½ç½®æ¡å½¢å›¾
                if (locationChart) {
                    locationChart.destroy();
                }

                const locationCtx = document.getElementById('locationChart').getContext('2d');
                locationChart = new Chart(locationCtx, {
                    type: 'bar',
                    data: {
                        labels: stats.countries.map(d => d.code),
                        datasets: [{
                            label: 'è®¿é—®é‡',
                            data: stats.countries.map(d => d.count),
                            backgroundColor: '#667eea',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const countryCode = context.label;
                                        const cities = stats.cities
                                            .filter(c => c.country === countryCode)
                                            .map(c => `${c.city}: ${c.count}`)
                                            .slice(0, 5);
                                        return cities.length > 0 ? cities : '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'è®¿é—®é‡'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'å›½å®¶/åœ°åŒº'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½åœ°ç†ä½ç½®ç»Ÿè®¡è¯¦ç»†é”™è¯¯:', error);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæŒ‰5åˆ†é’Ÿåˆ†ç»„æ—¶é—´æˆ³
        function groupByFiveMinutes(timestamps) {
            // ç”Ÿæˆ288ä¸ª5åˆ†é’Ÿæ—¶é—´æ®µï¼ˆ24å°æ—¶ * 12ä¸ª5åˆ†é’ŸåŒºé—´ï¼‰
            const now = new Date();
            const labels = [];
            const counts = Array(288).fill(0);

            // ç”Ÿæˆæ—¶é—´æ ‡ç­¾ï¼ˆæ¯5åˆ†é’Ÿä¸€ä¸ªï¼Œä½†åªåœ¨åŠå°æ—¶åˆ»åº¦æ˜¾ç¤ºæ ‡ç­¾ï¼‰
            for (let i = 287; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 5 * 60 * 1000);
                const hours = String(time.getHours()).padStart(2, '0');
                const minutes = String(time.getMinutes()).padStart(2, '0');

                // åªåœ¨åŠå°æ—¶åˆ»åº¦æ˜¾ç¤ºæ ‡ç­¾ï¼Œå…¶ä»–ä¸ºç©ºå­—ç¬¦ä¸²
                if (time.getMinutes() % 30 === 0) {
                    labels.push(`${hours}:${minutes}`);
                } else {
                    labels.push('');
                }
            }

            // ç»Ÿè®¡æ¯ä¸ª5åˆ†é’Ÿæ—¶é—´æ®µçš„è®¿é—®æ¬¡æ•°
            timestamps.forEach(ts => {
                if (!ts) return;
                const time = new Date(ts);
                const diffMs = now - time;
                const diffMinutes = Math.floor(diffMs / 1000 / 60);

                // åªç»Ÿè®¡æœ€è¿‘24å°æ—¶å†…çš„
                if (diffMinutes >= 0 && diffMinutes < 24 * 60) {
                    // è®¡ç®—å±äºå“ªä¸ª5åˆ†é’ŸåŒºé—´ï¼ˆä»åå¾€å‰æ•°ï¼‰
                    const slotIndex = Math.floor(diffMinutes / 5);
                    if (slotIndex >= 0 && slotIndex < 288) {
                        counts[287 - slotIndex]++;
                    }
                }
            });

            return { labels, counts };
        }

        // åŠ è½½ç®¡ç†å‘˜æœ¬åœ°æ—¶é—´è®¿é—®åˆ†å¸ƒ
        async function loadHourlyAdminChart() {
            try {
                const response = await API.stats.getHourlyAdmin();
                const timestamps = response.data.timestamps;

                // æŒ‰5åˆ†é’Ÿåˆ†ç»„
                const { labels, counts } = groupByFiveMinutes(timestamps);

                // é”€æ¯æ—§å›¾è¡¨
                if (hourlyAdminChart) {
                    hourlyAdminChart.destroy();
                }

                const ctx = document.getElementById('hourlyAdminChart').getContext('2d');
                hourlyAdminChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'è®¿é—®æ¬¡æ•°',
                            data: counts,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        // è®¡ç®—å®é™…æ—¶é—´
                                        const index = context[0].dataIndex;
                                        const now = new Date();
                                        const time = new Date(now.getTime() - (287 - index) * 5 * 60 * 1000);
                                        const hours = String(time.getHours()).padStart(2, '0');
                                        const minutes = String(time.getMinutes()).padStart(2, '0');
                                        return `æ—¶é—´: ${hours}:${minutes}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                title: {
                                    display: true,
                                    text: 'è®¿é—®æ¬¡æ•°'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´ï¼ˆç®¡ç†å‘˜æœ¬åœ°æ—¶é—´ï¼‰'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: false,
                                    callback: function(value, index) {
                                        // åªæ˜¾ç¤ºéç©ºæ ‡ç­¾
                                        return this.getLabelForValue(index);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½ç®¡ç†å‘˜æ—¶é—´åˆ†å¸ƒè¯¦ç»†é”™è¯¯:', error);
            }
        }

        // åŠ è½½è®¿é—®è€…æœ¬åœ°æ—¶é—´è®¿é—®åˆ†å¸ƒ
        async function loadHourlyVisitorChart(country = null) {
            try {
                const response = await API.stats.getHourlyVisitor(country);
                const timestamps = response.data.timestamps;

                // æŒ‰5åˆ†é’Ÿåˆ†ç»„
                const { labels, counts } = groupByFiveMinutes(timestamps);

                // é”€æ¯æ—§å›¾è¡¨
                if (hourlyVisitorChart) {
                    hourlyVisitorChart.destroy();
                }

                const ctx = document.getElementById('hourlyVisitorChart').getContext('2d');
                hourlyVisitorChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'è®¿é—®æ¬¡æ•°',
                            data: counts,
                            backgroundColor: 'rgba(72, 187, 120, 0.8)',
                            borderColor: '#48bb78',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        // è®¡ç®—å®é™…æ—¶é—´
                                        const index = context[0].dataIndex;
                                        const now = new Date();
                                        const time = new Date(now.getTime() - (287 - index) * 5 * 60 * 1000);
                                        const hours = String(time.getHours()).padStart(2, '0');
                                        const minutes = String(time.getMinutes()).padStart(2, '0');
                                        const countryText = country ? ` (${country})` : '';
                                        return `æ—¶é—´: ${hours}:${minutes}${countryText}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                },
                                title: {
                                    display: true,
                                    text: 'è®¿é—®æ¬¡æ•°'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´ï¼ˆè®¿é—®è€…æœ¬åœ°æ—¶é—´ï¼‰'
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: false,
                                    callback: function(value, index) {
                                        // åªæ˜¾ç¤ºéç©ºæ ‡ç­¾
                                        return this.getLabelForValue(index);
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('åŠ è½½è®¿é—®è€…æ—¶é—´åˆ†å¸ƒè¯¦ç»†é”™è¯¯:', error);
            }
        }

        // åŠ è½½å›½å®¶åˆ—è¡¨åˆ°ä¸‹æ‹‰æ¡†
        async function loadCountryList() {
            try {
                const response = await API.stats.getLocations(30); // è·å–æœ€è¿‘30å¤©çš„å›½å®¶æ•°æ®
                const countries = response.data.countries;

                const select = document.getElementById('visitorCountrySelect');
                // ä¿ç•™"æ‰€æœ‰å›½å®¶"é€‰é¡¹
                select.innerHTML = '<option value="">æ‰€æœ‰å›½å®¶</option>';

                // æ·»åŠ å›½å®¶é€‰é¡¹
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = `${country.code} (${country.count})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½å›½å®¶åˆ—è¡¨è¯¦ç»†é”™è¯¯:', error);
            }
        }
    </script>
</body>
</html>
