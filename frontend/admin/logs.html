<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¿é—®æ—¥å¿— - AdAlliance ç®¡ç†åå°</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <!-- jQuery (DataTables dependency) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ¯ AdAlliance</h2>
                <p>ç®¡ç†åå°</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/index.html" class="nav-item">ğŸ“Š ä»ªè¡¨ç›˜</a>
                <a href="/admin/logs.html" class="nav-item active">ğŸ“‹ è®¿é—®æ—¥å¿—</a>
                <a href="/public/index.html" class="nav-item">ğŸ§ª æµ‹è¯•é¡µé¢</a>
                <a href="/docs" class="nav-item">ğŸ“š API æ–‡æ¡£</a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <main class="main-content">
            <!-- é¡¶éƒ¨æ  -->
            <div class="top-bar">
                <h1>ğŸ“‹ è®¿é—®æ—¥å¿—</h1>
                <div class="top-bar-actions">
                    <button onclick="loadVisits()" class="btn btn-primary">ğŸ”„ åˆ·æ–°</button>
                    <button onclick="exportData()" class="btn btn-success">ğŸ“¥ å¯¼å‡ºCSV</button>
                </div>
            </div>

            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-item">
                    <label for="deviceFilter">è®¾å¤‡ç±»å‹</label>
                    <select id="deviceFilter" onchange="applyFilter()">
                        <option value="">å…¨éƒ¨</option>
                        <option value="pc">ğŸ’» ç”µè„‘</option>
                        <option value="mobile">ğŸ“± æ‰‹æœº</option>
                        <option value="tablet">ğŸ“± å¹³æ¿</option>
                        <option value="bot">ğŸ¤– æœºå™¨äºº</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="scoreFilter">æœ€ä½è¯„åˆ†</label>
                    <select id="scoreFilter" onchange="applyFilter()">
                        <option value="">å…¨éƒ¨</option>
                        <option value="80">80+ ä¼˜ç§€</option>
                        <option value="60">60+ è‰¯å¥½</option>
                        <option value="40">40+ ä¸€èˆ¬</option>
                        <option value="0">0+ å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="startDate">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" onchange="applyFilter()">
                </div>
                <div class="filter-item">
                    <label for="endDate">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" onchange="applyFilter()">
                </div>
            </div>

            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="card">
                <div class="card-header">
                    <h3>è®¿é—®è®°å½•åˆ—è¡¨</h3>
                </div>
                <div class="card-body">
                    <div id="tableContainer">
                        <table id="visitsTable" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>IP åœ°å€</th>
                                    <th>ä½ç½®</th>
                                    <th>è®¾å¤‡</th>
                                    <th>æµè§ˆå™¨</th>
                                    <th>åœç•™</th>
                                    <th>æ»šåŠ¨</th>
                                    <th>è¯„åˆ†</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="visitsBody">
                                <!-- æ•°æ®å°†é€šè¿‡ JavaScript åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px; overflow-y:auto;">
        <div style="max-width:800px; margin:50px auto; background:white; border-radius:12px; padding:30px; position:relative;">
            <button onclick="closeModal()" style="position:absolute; top:20px; right:20px; background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            <h2 style="margin-bottom:20px;">è®¿é—®è¯¦æƒ…</h2>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/static/js/admin/api.js"></script>
    <script>
        let visitsData = [];
        let dataTable;
        let currentFilters = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadVisits();
        });

        // åŠ è½½è®¿é—®è®°å½•
        async function loadVisits() {
            try {
                const params = {
                    page: 1,
                    page_size: 1000, // åŠ è½½æ›´å¤šæ•°æ®ç”¨äºå®¢æˆ·ç«¯ç­›é€‰
                    ...currentFilters
                };

                const response = await API.visits.getList(params);
                visitsData = response.data;

                initDataTable();
            } catch (error) {
                console.error('åŠ è½½è®¿é—®è®°å½•å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆå§‹åŒ– DataTables
        function initDataTable() {
            if (dataTable) {
                dataTable.destroy();
            }

            const tableData = visitsData.map(visit => [
                Format.datetime(visit.timestamp),
                visit.ip_address,
                `${visit.ip_country || '-'} ${visit.ip_city || ''}`.trim(),
                Format.deviceType(visit.device_type),
                visit.browser || '-',
                Format.duration(visit.stay_duration),
                `${visit.scroll_depth}%`,
                `<span style="color: ${getScoreColor(visit.authenticity_score)}">${Format.score(visit.authenticity_score)}</span>`,
                `<button onclick="viewDetail('${visit.visit_id}')" class="btn btn-sm btn-primary">æŸ¥çœ‹</button>
                 <button onclick="deleteVisit('${visit.visit_id}')" class="btn btn-sm btn-danger">åˆ é™¤</button>`
            ]);

            dataTable = $('#visitsTable').DataTable({
                data: tableData,
                pageLength: 20,
                order: [[0, 'desc']], // æŒ‰æ—¶é—´é™åº
                language: {
                    lengthMenu: 'æ¯é¡µæ˜¾ç¤º _MENU_ æ¡',
                    zeroRecords: 'æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•',
                    info: 'æ˜¾ç¤ºç¬¬ _START_ è‡³ _END_ æ¡ï¼Œå…± _TOTAL_ æ¡',
                    infoEmpty: 'æš‚æ— æ•°æ®',
                    infoFiltered: '(ä» _MAX_ æ¡è®°å½•ä¸­ç­›é€‰)',
                    search: 'æœç´¢:',
                    paginate: {
                        first: 'é¦–é¡µ',
                        last: 'æœ«é¡µ',
                        next: 'ä¸‹ä¸€é¡µ',
                        previous: 'ä¸Šä¸€é¡µ'
                    }
                }
            });
        }

        // åº”ç”¨ç­›é€‰
        function applyFilter() {
            const deviceType = document.getElementById('deviceFilter').value;
            const minScore = document.getElementById('scoreFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            currentFilters = {};
            if (deviceType) currentFilters.device_type = deviceType;
            if (minScore) currentFilters.min_score = minScore;
            if (startDate) currentFilters.start_date = startDate;
            if (endDate) currentFilters.end_date = endDate;

            loadVisits();
        }

        // æŸ¥çœ‹è¯¦æƒ…
        async function viewDetail(visitId) {
            try {
                const response = await API.visits.getDetail(visitId);
                const visit = response.data;

                const detailHTML = `
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3>åŸºç¡€ä¿¡æ¯</h3>
                            <table style="width:100%; border-collapse: collapse;">
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>è®¿é—®ID:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.visit_id}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>è®¿é—®æ—¶é—´:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${Format.datetime(visit.timestamp)}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>IP åœ°å€:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.ip_address}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>ä½ç½®:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.ip_country || '-'} ${visit.ip_city || ''}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>é¡µé¢URL:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.page_url}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>æ¥æº:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.referrer || '-'}</td></tr>
                            </table>
                        </div>

                        <div>
                            <h3>è®¾å¤‡ä¿¡æ¯</h3>
                            <table style="width:100%; border-collapse: collapse;">
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>è®¾å¤‡ç±»å‹:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${Format.deviceType(visit.device_type)}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>æµè§ˆå™¨:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.browser || '-'} ${visit.browser_version || ''}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>æ“ä½œç³»ç»Ÿ:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.os || '-'} ${visit.os_version || ''}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>å±å¹•åˆ†è¾¨ç‡:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.screen_resolution || '-'}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>æ—¶åŒº:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.timezone || '-'}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>è¯­è¨€:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.language || '-'}</td></tr>
                            </table>
                        </div>

                        <div>
                            <h3>æµè§ˆå™¨æŒ‡çº¹</h3>
                            <table style="width:100%; border-collapse: collapse;">
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>Canvas:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.canvas_fingerprint || '-'}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>WebGL:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.webgl_fingerprint || '-'}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>å­—ä½“å“ˆå¸Œ:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.fonts_hash || '-'}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>ç»¼åˆæŒ‡çº¹:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.fingerprint_hash}</td></tr>
                            </table>
                        </div>

                        <div>
                            <h3>è¡Œä¸ºæ•°æ®</h3>
                            <table style="width:100%; border-collapse: collapse;">
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>åœç•™æ—¶é—´:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${Format.duration(visit.stay_duration)}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>æ»šåŠ¨æ·±åº¦:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.scroll_depth}%</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>é¼ æ ‡è½¨è¿¹:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${visit.mouse_movements ? 'å·²è®°å½•' : 'æœªè®°å½•'}</td></tr>
                            </table>
                        </div>

                        <div>
                            <h3>åˆ†æç»“æœ</h3>
                            <table style="width:100%; border-collapse: collapse;">
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>çœŸå®æ€§è¯„åˆ†:</strong></td><td style="padding:8px; border-bottom:1px solid #eee; color:${getScoreColor(visit.authenticity_score)}"><strong>${Format.score(visit.authenticity_score)}</strong> ${Format.badge(visit.authenticity_score)}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>æ˜¯å¦æœºå™¨äºº:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${Format.boolean(visit.is_bot)}</td></tr>
                                <tr><td style="padding:8px; border-bottom:1px solid #eee;"><strong>æ˜¯å¦ä»£ç†:</strong></td><td style="padding:8px; border-bottom:1px solid #eee;">${Format.boolean(visit.is_proxy)}</td></tr>
                            </table>
                        </div>
                    </div>
                `;

                document.getElementById('detailContent').innerHTML = detailHTML;
                document.getElementById('detailModal').style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½è¯¦æƒ…å¤±è´¥');
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // åˆ é™¤è®¿é—®è®°å½•
        async function deleteVisit(visitId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®¿é—®è®°å½•å—ï¼Ÿ')) return;

            try {
                await API.visits.delete(visitId);
                alert('åˆ é™¤æˆåŠŸ');
                loadVisits();
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const exportData = visitsData.map(v => ({
                'æ—¶é—´': Format.datetime(v.timestamp),
                'IPåœ°å€': v.ip_address,
                'å›½å®¶': v.ip_country || '',
                'åŸå¸‚': v.ip_city || '',
                'è®¾å¤‡ç±»å‹': v.device_type || '',
                'æµè§ˆå™¨': v.browser || '',
                'æ“ä½œç³»ç»Ÿ': v.os || '',
                'åœç•™æ—¶é—´(ç§’)': v.stay_duration,
                'æ»šåŠ¨æ·±åº¦(%)': v.scroll_depth,
                'çœŸå®æ€§è¯„åˆ†': v.authenticity_score,
                'æ˜¯å¦æœºå™¨äºº': v.is_bot ? 'æ˜¯' : 'å¦'
            }));

            Utils.exportToCSV(exportData, `è®¿é—®æ—¥å¿—_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // è·å–è¯„åˆ†é¢œè‰²
        function getScoreColor(score) {
            if (score >= 80) return '#48bb78';
            if (score >= 60) return '#667eea';
            if (score >= 40) return '#ed8936';
            return '#f56565';
        }
    </script>
</body>
</html>
